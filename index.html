<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Outcomes and Explanatory Factors</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better visual appeal and compactness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background for the page */
        }
        .table-container {
            overflow-x: auto; /* Allows horizontal scrolling for the table if needed */
            padding-top: 5px; /* Reduced padding */
            padding-bottom: 5px; /* Reduced padding */
        }
        table {
            border-collapse: collapse; /* Ensures borders are neat */
            margin: 15px auto; /* Reduced margin, centers the table */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
            border-radius: 6px; /* Slightly rounded corners for the table */
        }
        th, td {
            border: 1px solid #e5e7eb; /* Light gray border for cells */
            padding: 0; /* Remove default padding, custom padding will be handled by inner elements or specific cell types */
            text-align: center; /* Center text in cells */
            min-width: 90px;    /* REDUCED: Minimum width for cells to ensure content readability */
            height: 75px;       /* REDUCED: Fixed height for cells for a uniform grid */
            position: relative; /* For positioning tooltips relative to cells */
        }
        th { /* Column headers */
            background-color: #4b5563; /* Darker gray for column headers */
            color: white; /* White text for contrast */
            padding: 8px 6px;   /* REDUCED: Padding for header text */
            font-weight: 600; /* Semi-bold font for headers */
            font-size: 0.7rem; /* REDUCED: Font size for headers */
            white-space: normal; /* Allow text wrapping in headers */
            position: sticky; /* Makes headers stick to the top when scrolling */
            top: 0;
            z-index: 20; /* Ensures headers stay above cell content */
        }
        td {
            background-color: #ffffff; /* White background for data cells */
        }
        .row-header { /* Row headers */
            background-color: #6b7280; /* Medium gray for row headers */
            color: white; /* White text for contrast */
            font-weight: 500; /* Medium font weight */
            padding: 8px 6px;   /* REDUCED: Padding for row header text */
            text-align: left; /* Align row header text to the left */
            font-size: 0.7rem; /* REDUCED: Font size for row headers */
            white-space: normal; /* Allow text wrapping */
            min-width: 150px;   /* REDUCED: Wider row headers for better readability of categories */
            position: sticky; /* Makes row headers stick to the left when scrolling horizontally */
            left: 0;
            z-index: 15; /* Ensures row headers stay above non-header cells but below column headers */
        }
        .circle-cell { /* Div inside TD to center the circle and manage tooltip */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        .tooltip {
            visibility: hidden; /* Hidden by default */
            background-color: #1f2937; /* Dark background for tooltip */
            color: #fff; /* White text for tooltip */
            text-align: left; /* Align tooltip text to the left */
            border-radius: 4px; /* Reduced radius */
            padding: 6px 10px;  /* REDUCED: Padding for tooltip */
            position: absolute; /* Positioned relative to the parent cell */
            z-index: 30; /* Ensures tooltip is above everything else */
            top: 105%; /* Position below the cell */
            left: 50%;
            transform: translateX(-50%); /* Center the tooltip */
            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s, visibility 0.2s; /* Faster transition for appearing/disappearing */
            font-size: 0.75rem; /* REDUCED: Font size for tooltip */
            white-space: normal; /* Allow text wrapping in tooltip */
            max-width: 240px;    /* REDUCED: Max width for the tooltip to prevent it from being too wide */
            word-wrap: break-word; /* Break long words */
            line-height: 1.3;    /* REDUCED: Line height for better readability in compact tooltips */
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); /* Subtle shadow for tooltip */
            pointer-events: none; /* Tooltip should not interfere with mouse events on the cell itself */
        }
        .tooltip strong { /* Styling for the count of studies in the tooltip */
            display: block;
            margin-bottom: 3px; /* Reduced margin */
        }
        .circle-cell:hover .tooltip { /* Show tooltip on hover */
            visibility: visible;
            opacity: 1;
        }

        thead tr th:first-child { /* Top-left corner header cell (empty) */
            z-index: 25; /* Above row and column headers */
            left: 0; /* Sticky to the left */
            background-color: #4b5563; /* Match column header background */
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) { /* Tablets and smaller */
            th, td {
                min-width: 70px;    /* REDUCED */
                height: 60px;       /* REDUCED */
            }
            th, .row-header {
                font-size: 0.65rem; /* REDUCED */
                padding: 6px 4px;   /* REDUCED */
            }
            .row-header {
                min-width: 120px;   /* REDUCED */
            }
            .tooltip {
                font-size: 0.7rem;  /* REDUCED */
                max-width: 180px;   /* REDUCED */
            }
            /* Reduce legend text size on small screens */
            .legend-text {
                font-size: 0.7rem; /* Corresponds to Tailwind's text-xs, or smaller if needed */
            }
            .legend-icon { /* Adjust legend icon size */
                width: 20px;
                height: 20px;
            }
            .legend-icon circle {
                /* SVG attributes are scaled by viewBox, direct r change if needed */
            }
             h1.main-title { /* Adjust main title size */
                font-size: 1.25rem; /* Tailwind text-xl */
            }
        }
         @media (max-width: 480px) { /* Extra small screens (smartphones) */
            th, td {
                min-width: 50px;
                height: 50px;
            }
            th, .row-header {
                font-size: 0.6rem;
            }
            .row-header {
                min-width: 100px;
            }
            .tooltip {
                font-size: 0.65rem;
                max-width: 150px;
            }
            h1.main-title {
                font-size: 1.125rem; /* Tailwind text-lg */
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 p-2 md:p-4"> <div class="container mx-auto"> <h1 class="main-title text-xl md:text-2xl font-bold text-center text-gray-700 mb-4">Study Outcomes and Their Explanatory Factors</h1>

        <div id="evidenceMapContainer" class="table-container">
            </div>

        <div class="mt-4 p-3 bg-white rounded-lg shadow-md"> <h3 class="text-base font-semibold text-gray-700 mb-2">Legend</h3>
            <div class="flex items-center space-x-3"> <div class="flex items-center space-x-1">
                    <svg class="legend-icon" width="25" height="25" viewBox="0 0 30 30"> <circle cx="15" cy="15" r="3" fill="#3b82f6" />
                    </svg>
                    <span class="legend-text text-xs text-gray-600">Few studies</span>
                </div>
                <div class="flex items-center space-x-1">
                    <svg class="legend-icon" width="25" height="25" viewBox="0 0 30 30"> <circle cx="15" cy="15" r="7" fill="#3b82f6" />
                    </svg>
                    <span class="legend-text text-xs text-gray-600">Some studies</span>
                </div>
                <div class="flex items-center space-x-1">
                    <svg class="legend-icon" width="25" height="25" viewBox="0 0 30 30"> <circle cx="15" cy="15" r="12" fill="#3b82f6" />
                    </svg>
                    <span class="legend-text text-xs text-gray-600">Many studies</span>
                </div>
            </div>
             <p class="text-xs text-gray-500 mt-1">Circle size is relative to the maximum number of studies in the dataset.</p>
        </div>
    </div>

    <script>
        // --- DATA CONFIGURATION ---
        // Raw CSV-like data string. This data represents the relationships between study outcomes and explanatory factors.
        // Each cell can contain study identifiers (e.g., "#1", "#2D").
        const rawDataFromDocx = `,Outcomes\r\n,Dental/Oral Condition: Dental Decay/Tooth Loss,Dental Hospitalisation (diagnoses and treatment),Medical Conditions/Treatments/Presentations: Psychological and Social Health,Medical Conditions/Treatments/Presentations: Cognitive Health,Oral and Pharyngeal Microbiota,Salivary Immunoglobulin,Oral Function (Remaining Teeth Composition/Denture Use/Chewing/Swallowing),Dental/Oral Condition: Periodontal Disease,non-specific oral health,Tooth Size and Shape,"Orthodontic need, treatment and success (including occlusal relations)",Tooth Eruption,Dental/Oral Condition: Dental Trauma,Dental/Oral Condition: Dry Mouth,Dental/Oral Condition: Dental Wear,Dental/Oral Condition: Developmental Dental Defects,Dental/Oral Condition: Temporomandibular joint Disease (TMD),Dental/Oral Condition: Oral Human Papillomavirus (HPV),Dental/Oral Condition: Oral Cancer and Epithelial Dysplasia,"Oral Hygiene, Behaviours and Beliefs",Third Molar Status and Outcome,Medical Conditions/Treatments/Presentations: Heart conditions,Medical Conditions/Treatments/Presentations: Diabetes and Metabolic Disorders,Medical Conditions/Treatments/Presentations: Obesity and Weight Loss,Medical Conditions/Treatments/Presentations: Other,Perception of Personal General Health and Needs ,Substance Use (Including Smoking and Alcohol),Diet and Nutrient Intake,Infant Feeding,Use of Dental Service,Perception of Personal Oral Health and Needs (Including Oral Health Quality of Life) ,Dental Anxiety\r\nExplanatory Factors,Sociodemographic/Economic/Cultural Factors (Including Access and Use of Dental Services),"#1, #2, #3, #5, #7, #8, #9, #10, #11, #12, #13, #15, #17, #18, #19, #20, #21, #27, #28, #29, #30, #32, #36, #2D, #5D","#1D, #2D, #5D, #6D, #8D","#1, #3, #11",,"#2, #13",,"#6, #16","#3, #6, #7, #14, #29",#3,,"#1, #7, #34, #29",#26,#10,,#4,"#4, #7, #17, #18, #25, #29",,#24,#9D,"#6, #7, #9, #10, #15, #30",,"#7, #16, #4D","#7, #16","#6, #10, #15, #21","#7, #30, #31, #9D",#15,#7,#6,#23,"#5, #6, #7, #10, #37","#6, #7, #9, #15, #25, #29, #34",#7\r\n,Anthropometric Measurements,"#3, #10, #18",,,,,,#16,#3,,,,,,,,,,,,,,#16,"#7, #16",#6,"#31, #35",,,#6,,,,\r\n,Substance Use (Including Smoking and Alcohol),"#3, #7, #14, #16, #29",,#3,,,,"#6, #16","#3, #7, #14, #29",,,#29,,,#14,,#29,,#24,"#7D, #9D, #10D",#6,,"#7, #16","#7, #16",#6,"#7, #30, #31, #7D, #9D",#15,,#6,,#6,"#6, #7, #15, #29",\r\n,Physical Activity,,,,,,,#6,,,,,,,,,,,,,,,,,#10,,,,#6,,,,\r\n,"Oral Hygiene, Behaviours and Beliefs","#1, #2, #3, #4, #7, #9, #10, #11, #12, #13, #14, #15, #17, #18, #19, #20, #21, #27, #28, #32, #36, #2D",#2D,"#1, #3, #11",,"#2, #4, #13",,,"#3, #7, #14",#3,,#1,,#10,,,"#4, #7, #17",,#24,,#9,,#7,,#21,"#30, #33",#15,,,,,"#7, #9, #15",\r\n,"Oral and Dental Condition/Treatment: Orthodontic Treatment, Need, and Occlusal Relations","#1, #7, #8",,"#1, #11",,,,,#7,,,"#1, #7, #34",,,,,,#7,,,,#7,,,,,,,,,,"#25, #34",\r\n,Oral and Dental Condition/Treatment: Dental Decay/Extraction/ Restoration,,,"#3, #11",,,,#6,#7,#3,,#1,,,,,#7,,#24,,,,"#16, #4D",#16,#10,"#5, #7, #30, #31",,,,,#7,"#6, #7, #25",#7\r\n,Oral and Dental Condition/Treatment: Developmental Dental Defects,"#13, #18",,,,#3,,,,,#4,,,,,,,,,,,,,,,#35,,,,,,#25,\r\n,Oral and Dental Condition/Treatment: Periodontal Disease,,,#11,,,,#6,,,,#7,,,,,,,#24,,,,#16,"#7, #16",,,,,,,,"#6, #7",\r\n,Oral and Dental Condition/Treatment: Dry Mouth,#14,,,,,,,,,,,,,,,,,,,,,,,#6,#14,,,,,,#7,\r\n,Oral and Dental Condition/Treatment: Dental Trauma,,,#11,,,,,,,,,,,,,#7,,,,,,,,,,,,,,,, \r\n,Oral and Dental Condition/Treatment: Temporomandibular joint Disease (TMD),,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#7,\r\n,Oral and Dental Condition/Treatment: Oral Cancer,,,,,,,,,,,,,,,,,,,"#7D, #9D",,,,,,"#7D, #9D",,,,,,, \r\n,Oral and Dental Condition/Treatment: Oral Lichen Planus and Lichenoid Lesions (OLP/OLL),,,,,,,,,,,,,,,,,,,#10D,,,,,,,,,,,,, \r\n,Oral and Dental Condition/Treatment: Other,#12,,#11,,,,,,,,,,,,,,,,,,,,,,,,,,,,, \r\n,Perception of Personal Oral Health and Needs (Including Oral Health Quality of Life),"#7, #19",,#3,,,,#6,,,,#1,,,,,,,#24,,#6,,#16,#16,,"#5, #7, #31",,,,,#6,"#6, #7",, \r\n,Oral Function (Remaining Teeth Composition/Denture Use/Chewing/Swallowing/Other),#14,,,#6,,,#6,,,,,,,,,,,#24,,#6,,,,#6,#31,,,#6,,#6,"#6, #7", \r\n,Oral Parafunction (Grinding/Clenching/Other),,,,,,,,,,,#7,,,,,,#7,,,,,,,,,,,,,,#7, \r\n,Diet and Nutrient Intake,"#2, #3, #4, #9, #10, #11, #12, #15, #17, #18, #20, #21, #27, #28, #36, #2D",#2D,,,"#2, #4",,#16,#3,#3,,,,,,#4,#4,,,,#9,,,,"#10, #15, #21",,,,,,,#9, \r\n,Infant Feeding,"#2, #10, #11, #15, #17, #18, #19, #20, #21, #36",,,,"#2, #13",#2,,,,,,#4,,,,#18,,,,,,,,"#10, #15, #21",,,,,,,, \r\n,Oral Microbiota,"#8, #13, #19, #36",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,, \r\n,Salivary pH,#8,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,, \r\n,Parental Health and Habits,"#2, #7, #8, #10, #11, #12, #15, #18, #19, #20, #32, #36",#6D,,,"#2, #13",,,#7,,,"#1, #10",,#10,,,"#10, #18",,,,"#7, #10",,,,"#10, #15","#7, #30",,,,,,#7, \r\n,Perception of Personal General Health and Needs ,#19,,,,,,#6,,,,,,,,,,,#24,,#6,,,,,,,,#6,,#6,#6, \r\n,Medical Conditions/Treatments/Presentations: Childhood Infection and Antibiotics,"#2, #18",,,,#2,,,,,,,,,,,"#4, #7, #18",,,,,,,,,,,,,,,, \r\n,Medical Conditions/Treatments/Presentations: Diabetes and Metabolic Disorders,,,,,,,,#14,,,,,,,,,,,,,,#16,,,,,,,,,, \r\n,"Medical Conditions/Treatments/Presentations: Premature Birth, Birth Weight, and other Peri-birth issues","#8, #11, #18, #19, #20, #29, #32",,,,#4,#2,,#29,,#4,#29,"#4, #26",,,#4,"#4, #18, #29",,,,,,,,,#30,,,,,,#29, \r\n,Medical Conditions/Treatments/Presentations: Intelligence and Cognitive Status,#7,#1D,,,,,,#7,,,,,,,,,,,,#7,,,,,#31,,,,,#7,#7, \r\n,Medical Conditions/Treatments/Presentations: Disability,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,"#10, #37",, \r\n,Medical Conditions/Treatments/Presentations: Psychological Health and Personality Traits,#7,,,,,,,#7,,,#7,,,,,,#7,,,,,,#16,,"#7, #31",,,,,,#7,#7 \r\n,Medical Conditions/Treatments/Presentations: Other,"#7, #12, #14, #18, #2D","#2D, #6D, #8D",,,#33,,#6,#14,#33,,,#26,,"#7, #14",#4,"#7, #18",,#24,#10D,#6,,#16,,#6,"#31, #33",#15,,#6,,#6,"#6, #15", \r\n,Tooth Eruption,#13,,,,#4,#2,,,,,,,,,,,,,,,,,,,,,,,,,, \r\n,Tooth Exfoliation,,,,,,,,,,,,,,,,#7,,,,,,,,,,,,,,,, \r\n,Dental Anxiety,"#3, #7",,,,,,,,,,,,,,,,,,,#7,,,,,,,,,,#7,#7, \r\n,Genetics,#4,,,,#4,,,#7,,#4,,#4,,,#4,"#4, #18",,,,,,,,,,,,,,,, \r\n,Fluoride Sources,"#5, #7, #10, #12, #17, #20, #27, #28, #36, #2D",#2D,,,,,,,,,,,,,,"#7, #25",,,,#7,,,,,#30,,,,,,, \r\n,Radiographic Position of Third Molars,,,,,,,,,,,,,,,,,,,,,#7,,,,,,,,,,, \r\n,Amalgam Exposure,,,,,,,,,,,,,,,,,,,,,,,,,#3D,,,,,,,`;

        /**
         * Cleans a cell string by trimming whitespace and removing surrounding quotes.
         * This is important for parsing CSV data where fields might be quoted.
         * @param {string} text - The text from a CSV cell.
         * @returns {string} The cleaned text.
         */
        function cleanCell(text) {
            if (typeof text !== 'string') return ""; // Handle non-string inputs gracefully
            let cleaned = text.trim();
            // Remove quotes if the entire cell content is quoted
            if (cleaned.startsWith('"') && cleaned.endsWith('"')) {
                cleaned = cleaned.substring(1, cleaned.length - 1);
            }
            return cleaned.trim(); // Trim again in case of spaces inside quotes
        }

        /**
         * Parses a single line of CSV text into an array of strings (cells).
         * Handles commas within quoted fields (e.g., "Value, with comma").
         * Also handles escaped quotes (e.g., "Value with ""quote""").
         * @param {string} lineString - A single line from the CSV data.
         * @returns {string[]} An array of cell values.
         */
        function parseCsvLineToArray(lineString) {
            const cells = [];
            let currentCell = '';
            let inQuotes = false;
            for (let i = 0; i < lineString.length; i++) {
                const char = lineString[i];
                if (char === '"') {
                    // Check for escaped quote (two double quotes)
                    if (inQuotes && i + 1 < lineString.length && lineString[i+1] === '"') {
                        currentCell += '"'; // Add a single double quote to the cell
                        i++; // Skip the next double quote
                    } else {
                        inQuotes = !inQuotes; // Toggle the inQuotes state
                    }
                } else if (char === ',' && !inQuotes) {
                    // If comma is encountered and not inside quotes, it's a cell delimiter
                    cells.push(cleanCell(currentCell));
                    currentCell = ''; // Reset for the next cell
                } else {
                    currentCell += char; // Append character to the current cell
                }
            }
            cells.push(cleanCell(currentCell)); // Add the last cell
            return cells;
        }

        /**
         * Counts the number of valid study identifiers (e.g., "#1", "#2D") in a pre-cleaned study string.
         * Study identifiers are expected to start with '#' and have at least one character after it.
         * @param {string} alreadyCleanedStudyString - A string containing comma-separated study IDs, already cleaned by cleanCell.
         * @returns {number} The count of valid study IDs.
         */
        function countStudies(alreadyCleanedStudyString) {
            if (typeof alreadyCleanedStudyString !== 'string' || !alreadyCleanedStudyString) {
                return 0; // Return 0 if input is invalid or empty
            }
            // Split by comma, trim each part, and filter for valid study IDs
            const parts = alreadyCleanedStudyString.split(',')
                .map(s => s.trim())
                .filter(s => s.startsWith('#') && s.length > 1); // Ensure it's a valid ID format
            return parts.length;
        }

        // --- PARSING LOGIC ---
        // Split the raw data into lines, removing any empty lines.
        const lines = rawDataFromDocx.split(/\r\n|\r|\n/).filter(line => line.trim() !== "");
        
        let parsedRowCategories = []; // Will store the names of row categories (Explanatory Factors)
        let parsedColumnCategories = []; // Will store the names of column categories (Outcomes)
        let parsedStudyCounts = []; // 2D array to store the count of studies for each cell
        let parsedStudyIdStrings = []; // 2D array to store the raw study ID strings for tooltips

        // Expecting at least 3 lines: 1 empty/header, 1 for column categories, and 1+ for row data.
        if (lines.length > 2) {
            // The second line (index 1) contains column categories, skipping the first empty cell.
            parsedColumnCategories = parseCsvLineToArray(lines[1]).slice(1);

            // Process each subsequent line for row categories and data.
            for (let i = 2; i < lines.length; i++) {
                const dataRowCells = parseCsvLineToArray(lines[i]);
                // Ensure the row has at least two cells (first empty/ignored, second is row category name)
                if (dataRowCells.length > 1) {
                    const rowCategoryName = dataRowCells[1]; // Second cell is the row category name
                    parsedRowCategories.push(rowCategoryName);

                    let countsForRow = []; // Store study counts for the current row
                    let idsForRow = [];    // Store study ID strings for the current row

                    // Iterate through each column category to populate data for the current row
                    for (let j = 0; j < parsedColumnCategories.length; j++) {
                        // Data cells start from the third cell in the CSV row (index 2)
                        const dataCellIndex = j + 2;
                        // Get the cell value, or an empty string if out of bounds
                        const cellValue = (dataCellIndex < dataRowCells.length) ? dataRowCells[dataCellIndex] : "";
                        countsForRow.push(countStudies(cellValue)); // Count studies from the cell value
                        idsForRow.push(cellValue); // Store the raw string for tooltip
                    }
                    parsedStudyCounts.push(countsForRow);
                    parsedStudyIdStrings.push(idsForRow);
                }
            }
        } else {
            console.error("Raw data does not have the expected structure (too few lines). Check 'rawDataFromDocx'.");
        }
        
        // --- COLUMN REORDERING LOGIC ---
        const desiredColumnOrder = [
            "Dental/Oral Condition: Dental Decay/Tooth Loss",
            "Dental/Oral Condition: Periodontal Disease",
            "Dental/Oral Condition: Developmental Dental Defects",
            "Dental/Oral Condition: Dental Trauma",
            "Dental/Oral Condition: Dry Mouth",
            "Dental/Oral Condition: Dental Wear",
            "Dental/Oral Condition: Temporomandibular joint Disease (TMD)",
            "Dental/Oral Condition: Oral Cancer and Epithelial Dysplasia",
            "Dental/Oral Condition: Oral Human Papillomavirus (HPV)",
            "Dental Hospitalisation (diagnoses and treatment)",
            "Orthodontic need, treatment and success (including occlusal relations)",
            "Oral Function (Remaining Teeth Composition/Denture Use/Chewing/Swallowing)",
            "Tooth Eruption",
            "Tooth Size and Shape",
            "Third Molar Status and Outcome",
            "Oral and Pharyngeal Microbiota",
            "Salivary Immunoglobulin",
            "Perception of Personal Oral Health and Needs (Including Oral Health Quality of Life)",
            "Dental Anxiety",
            "Oral Hygiene, Behaviours and Beliefs",
            "Use of Dental Service",
            "non-specific oral health",
            "Medical Conditions/Treatments/Presentations: Heart conditions",
            "Medical Conditions/Treatments/Presentations: Diabetes and Metabolic Disorders",
            "Medical Conditions/Treatments/Presentations: Obesity and Weight Loss",
            "Medical Conditions/Treatments/Presentations: Psychological and Social Health",
            "Medical Conditions/Treatments/Presentations: Cognitive Health",
            "Medical Conditions/Treatments/Presentations: Other",
            "Perception of Personal General Health and Needs",
            "Diet and Nutrient Intake",
            "Infant Feeding",
            "Substance Use (Including Smoking and Alcohol)"
        ];

        const originalColumnCategoriesSnapshot = [...parsedColumnCategories]; 
        const columnOrderMapping = desiredColumnOrder.map(desiredName => {
            const originalIndex = originalColumnCategoriesSnapshot.indexOf(desiredName);
            if (originalIndex === -1) {
                console.error(`Column name "${desiredName}" from desired order not found in original columns. This should not happen if pre-check passed.`);
            }
            return originalIndex;
        }).filter(index => index !== -1); 

        if (columnOrderMapping.length === desiredColumnOrder.length && columnOrderMapping.length === originalColumnCategoriesSnapshot.length) {
            parsedColumnCategories = [...desiredColumnOrder];
            parsedStudyCounts = parsedStudyCounts.map(originalDataRow => {
                return columnOrderMapping.map(originalColIndex => originalDataRow[originalColIndex]);
            });
            parsedStudyIdStrings = parsedStudyIdStrings.map(originalIdRow => {
                return columnOrderMapping.map(originalColIndex => originalIdRow[originalColIndex]);
            });
        } else {
            console.error("Could not reorder columns due to mismatch or mapping error. Using original column order. Desired:", desiredColumnOrder.length, "Mapped:", columnOrderMapping.length, "Original:", originalColumnCategoriesSnapshot.length);
            parsedColumnCategories = [...originalColumnCategoriesSnapshot]; 
        }
        // --- END OF COLUMN REORDERING LOGIC ---
        
        // --- ROW REORDERING LOGIC ---
        const desiredRowOrder = [
            "Sociodemographic/Economic/Cultural Factors (Including Access and Use of Dental Services)",
            "Substance Use (Including Smoking and Alcohol)",
            "Oral Hygiene, Behaviours and Beliefs",
            "Oral and Dental Condition/Treatment: Dental Decay/Extraction/ Restoration",
            "Oral and Dental Condition/Treatment: Developmental Dental Defects",
            "Oral and Dental Condition/Treatment: Periodontal Disease",
            "Oral and Dental Condition/Treatment: Dry Mouth",
            "Oral and Dental Condition/Treatment: Dental Trauma",
            "Oral and Dental Condition/Treatment: Orthodontic Treatment, Need, and Occlusal Relations",
            "Oral and Dental Condition/Treatment: Temporomandibular joint Disease (TMD)",
            "Oral and Dental Condition/Treatment: Oral Cancer",
            "Oral and Dental Condition/Treatment: Oral Lichen Planus and Lichenoid Lesions (OLP/OLL)",
            "Oral and Dental Condition/Treatment: Other",
            "Perception of Personal Oral Health and Needs (Including Oral Health Quality of Life)",
            "Oral Function (Remaining Teeth Composition/Denture Use/Chewing/Swallowing/Other)",
            "Oral Parafunction (Grinding/Clenching/Other)",
            "Oral Microbiota",
            "Salivary pH",
            "Tooth Eruption",
            "Tooth Exfoliation",
            "Fluoride Sources",
            "Radiographic Position of Third Molars",
            "Amalgam Exposure",
            "Dental Anxiety",
            "Medical Conditions/Treatments/Presentations: Childhood Infection and Antibiotics",
            "Medical Conditions/Treatments/Presentations: Diabetes and Metabolic Disorders",
            "Medical Conditions/Treatments/Presentations: Premature Birth, Birth Weight, and other Peri-birth issues",
            "Medical Conditions/Treatments/Presentations: Psychological Health and Personality Traits",
            "Medical Conditions/Treatments/Presentations: Intelligence and Cognitive Status",
            "Medical Conditions/Treatments/Presentations: Disability",
            "Medical Conditions/Treatments/Presentations: Other",
            "Perception of Personal General Health and Needs",
            "Anthropometric Measurements",
            "Diet and Nutrient Intake",
            "Infant Feeding",
            "Physical Activity",
            "Parental Health and Habits",
            "Genetics"
        ];

        const originalRowCategoriesSnapshot_ForRowReorder = [...parsedRowCategories]; // Snapshot of current row categories
        const originalStudyCountsSnapshot_ForRowReorder = [...parsedStudyCounts]; // Snapshot of current study counts (already column-reordered)
        const originalStudyIdStringsSnapshot_ForRowReorder = [...parsedStudyIdStrings]; // Snapshot of current study IDs (already column-reordered)

        const rowOrderMapping = desiredRowOrder.map(desiredName => {
            const originalIndex = originalRowCategoriesSnapshot_ForRowReorder.indexOf(desiredName);
            if (originalIndex === -1) {
                console.error(`Row name "${desiredName}" from desired order not found in original rows. This should not happen if pre-check passed.`);
            }
            return originalIndex;
        }).filter(index => index !== -1);

        if (rowOrderMapping.length === desiredRowOrder.length && rowOrderMapping.length === originalRowCategoriesSnapshot_ForRowReorder.length) {
            parsedRowCategories = [...desiredRowOrder];
            parsedStudyCounts = rowOrderMapping.map(originalRowIndex => originalStudyCountsSnapshot_ForRowReorder[originalRowIndex]);
            parsedStudyIdStrings = rowOrderMapping.map(originalRowIndex => originalStudyIdStringsSnapshot_ForRowReorder[originalRowIndex]);
        } else {
            console.error("Could not reorder rows due to mismatch or mapping error. Using original row order. Desired:", desiredRowOrder.length, "Mapped:", rowOrderMapping.length, "Original:", originalRowCategoriesSnapshot_ForRowReorder.length);
            parsedRowCategories = [...originalRowCategoriesSnapshot_ForRowReorder]; // Fallback
            // If row reordering fails, we should ideally revert studyCounts and studyIdStrings to their column-reordered state before row attempt.
            // However, since snapshots are taken right before, they hold the correct pre-row-reorder state.
             parsedStudyCounts = [...originalStudyCountsSnapshot_ForRowReorder];
             parsedStudyIdStrings = [...originalStudyIdStringsSnapshot_ForRowReorder];
        }
        // --- END OF ROW REORDERING LOGIC ---
        
        // --- FINAL DATA STRUCTURE FOR THE MAP ---
        const evidenceData = {
            rowCategories: parsedRowCategories, 
            columnCategories: parsedColumnCategories, 
            studyCounts: parsedStudyCounts,         
            studyIdStrings: parsedStudyIdStrings,   
            circleColor: "#3b82f6", 
            maxCircleRadius: 12,    
            minCircleRadius: 2      
        };
        // --- END OF PARSED DATA ---

        /**
         * Generates and renders the evidence gap map table into the specified HTML container.
         * @param {object} data - The parsed evidence data object.
         * @param {string} containerId - The ID of the HTML element to contain the map.
         */
        function createEvidenceGapMap(data, containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error("Container element not found:", containerId);
                return;
            }

            // Basic data validation to ensure essential parts are present and structured correctly.
            if (!data.rowCategories || !data.columnCategories || !data.studyCounts || !data.studyIdStrings ||
                data.rowCategories.length === 0 || data.columnCategories.length === 0 ||
                data.rowCategories.length !== data.studyCounts.length ||
                data.rowCategories.length !== data.studyIdStrings.length ||
                (data.studyCounts.length > 0 && data.studyCounts.some(row => !Array.isArray(row) || row.length !== data.columnCategories.length)) ||
                (data.studyIdStrings.length > 0 && data.studyIdStrings.some(row => !Array.isArray(row) || row.length !== data.columnCategories.length))) {
                container.innerHTML = '<p class="text-red-500 text-center">Error: Data structure is incorrect or incomplete. Check console for details.</p>';
                console.error("Data structure mismatch or empty data. Review parsed data:", data);
                return;
            }

            // Find the maximum number of studies in any cell to scale circle sizes.
            let maxStudies = 0;
            data.studyCounts.forEach(row => {
                row.forEach(count => {
                    if (typeof count === 'number' && count > maxStudies) {
                        maxStudies = count;
                    }
                });
            });
            if (maxStudies === 0) maxStudies = 1; // Avoid division by zero if no studies found.

            // Create table elements
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200'; // Tailwind classes for basic styling
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // Add an empty top-left header cell
            const thEmpty = document.createElement('th');
            thEmpty.scope = 'col'; // For accessibility
            headerRow.appendChild(thEmpty);

            // Add column headers (these are now from the potentially reordered data.columnCategories)
            data.columnCategories.forEach(colCategory => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.textContent = colCategory;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            // Add rows and cells
            data.rowCategories.forEach((rowCategory, rowIndex) => {
                const tr = document.createElement('tr');
                
                // Add row header
                const thRowHeader = document.createElement('th');
                thRowHeader.scope = 'row'; // For accessibility
                thRowHeader.textContent = rowCategory;
                thRowHeader.className = 'row-header'; // Custom class for sticky positioning and styling
                tr.appendChild(thRowHeader);

                // Add data cells for each column in the current row
                data.columnCategories.forEach((_, colIndex) => {
                    const td = document.createElement('td');
                    const studyCount = data.studyCounts[rowIndex][colIndex];
                    const studyIdsString = data.studyIdStrings[rowIndex][colIndex];
                    
                    const cellContentDiv = document.createElement('div');
                    cellContentDiv.className = 'circle-cell'; // For centering circle and tooltip handling

                    const tooltip = document.createElement('span');
                    tooltip.className = 'tooltip'; // For hover tooltip

                    if (typeof studyCount === 'number' && studyCount > 0) {
                        // Calculate circle radius based on study count relative to maxStudies
                        let radius = data.minCircleRadius;
                        if (maxStudies > 0) { // Ensure maxStudies is not zero before division
                           radius = (studyCount / maxStudies) * (data.maxCircleRadius - data.minCircleRadius) + data.minCircleRadius;
                        }
                        // Clamp radius to min/max values
                        radius = Math.max(data.minCircleRadius, Math.min(radius, data.maxCircleRadius));

                        // Create SVG circle
                        const svgNS = "http://www.w3.org/2000/svg";
                        const svg = document.createElementNS(svgNS, "svg");
                        const svgSize = data.maxCircleRadius * 2 + 6; // SVG canvas size, allowing padding around max circle
                        svg.setAttribute("width", String(svgSize));
                        svg.setAttribute("height", String(svgSize));
                        svg.setAttribute("viewBox", `0 0 ${svgSize} ${svgSize}`);
                        
                        const circleElement = document.createElementNS(svgNS, "circle");
                        circleElement.setAttribute("cx", String(svgSize / 2)); // Center circle in SVG
                        circleElement.setAttribute("cy", String(svgSize / 2));
                        circleElement.setAttribute("r", String(radius));
                        circleElement.setAttribute("fill", data.circleColor);
                        svg.appendChild(circleElement);
                        cellContentDiv.appendChild(svg);
                        
                        // Prepare tooltip content
                        const countText = `<strong>${studyCount} stud${studyCount === 1 ? 'y' : 'ies'}</strong>`;
                        const idsText = studyIdsString ? studyIdsString.split(',').map(s => s.trim()).filter(s => s).join('<br>') : 'IDs not available';
                        tooltip.innerHTML = `${countText}${idsText}`;

                    } else {
                        // If no studies, display "" (empty string) or "-"
                        const noStudiesText = document.createElement('span');
                        noStudiesText.textContent = (typeof studyCount === 'number' && studyCount === 0) ? "" : "-"; // MODIFIED HERE
                        noStudiesText.className = "text-gray-400 text-xs"; 
                        cellContentDiv.appendChild(noStudiesText);
                        tooltip.textContent = `0 studies`; // Simple tooltip for empty cells
                    }
                    cellContentDiv.appendChild(tooltip); // Add tooltip to the cell content div
                    td.appendChild(cellContentDiv); // Add content div to the table cell
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            container.innerHTML = ''; // Clear any existing content (e.g., loading message)
            container.appendChild(table); // Add the generated table to the container
        }

        // --- SCRIPT EXECUTION ---
        // Wait for the DOM to be fully loaded before trying to manipulate it.
        document.addEventListener('DOMContentLoaded', () => {
            // Set the document title from the main heading for better browser tab identification.
            const mainTitleElement = document.querySelector('h1.main-title');
            if (mainTitleElement && mainTitleElement.textContent) {
                document.title = mainTitleElement.textContent.trim();
            }

            // Check if data parsing resulted in empty arrays, which might indicate an issue.
            if (evidenceData.rowCategories.length === 0 && evidenceData.columnCategories.length === 0 && evidenceData.studyCounts.length === 0) {
                 console.warn("Evidence data appears to be empty after parsing. This might be due to issues with 'rawDataFromDocx' or the parsing logic. The map may not display correctly.");
                 const container = document.getElementById('evidenceMapContainer');
                 if(container) { // Display a warning in the UI if the container exists
                    container.innerHTML = '<p class="text-orange-500 text-center">Warning: Parsed data is empty or parsing failed. The evidence map cannot be generated. Please check the console for more details.</p>';
                 }
            }
            // Generate and display the evidence gap map.
            createEvidenceGapMap(evidenceData, 'evidenceMapContainer');
        });
    </script>

</body>
</html>
